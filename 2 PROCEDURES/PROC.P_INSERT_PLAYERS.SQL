create or replace PROCEDURE P_INSERT_PLAYERS IS
	
--CURSOR QUERY INPUTS FOR POPULATING PLAYERS
	VI_PLAYER VARCHAR2(50);
	VI_NATION VARCHAR2(20);
	VI_WC_GROUP VARCHAR2(1);

	CURSOR C_PLAYERS IS
		SELECT DISTINCT(PLAYER) AS PLAYER, NATION, WC_GROUP  FROM WORLDCUP_GOALS
		UNION
		SELECT DISTINCT(ASSIST) AS PLAYER, NATION, WC_GROUP  FROM WORLDCUP_GOALS
		WHERE ASSIST IS NOT NULL
		UNION
		SELECT DISTINCT(PLAYER) AS PLAYER, NATION, WC_GROUP  FROM WORLDCUP_CARDS
		WHERE PLAYER IS NOT NULL;

--CURSOR QUERY INPUTS FOR POPULATING GOALS
	VI_ASSIST_PLAYER VARCHAR2(20);
	VI_TYPE VARCHAR2(20);
	VO_GOALS NUMBER;
	VO_ASSISTS NUMBER;
	VO_OWN_GOALS NUMBER;

	CURSOR C_GOALS IS
		SELECT PLAYER, NATION, WC_GROUP, TYPE, ASSIST FROM WORLDCUP_GOALS;

--CURSOR QUERY INPUTS FOR POPULATING PLAYER CARDS
	VI_COLOR VARCHAR2(20);
	VO_YELLOW NUMBER;
	VO_RED NUMBER;

	CURSOR C_CARDS IS
		SELECT PLAYER, NATION, WC_GROUP, COLOR FROM WORLDCUP_CARDS;

BEGIN
DELETE FROM WORLDCUP_PLAYERS;
--COMMIT;


--POPULATE ALL PLAYERS WHO HAVE ANY GOAL, ASSIST, OWN GOAL OR CARD
	OPEN C_PLAYERS;
	LOOP
		FETCH C_PLAYERS INTO VI_PLAYER, VI_NATION, VI_WC_GROUP;
		EXIT WHEN C_PLAYERS%NOTFOUND;

		INSERT INTO WORLDCUP_PLAYERS VALUES (VI_PLAYER,VI_NATION,VI_WC_GROUP,0,0,0,0,0);
		--COMMIT;
	END LOOP;
	CLOSE C_PLAYERS;


--POPULATE GOALS, ASSISTS AND OWN GOAL COUNTS
	OPEN C_GOALS;
	LOOP
		FETCH C_GOALS INTO VI_PLAYER, VI_NATION, VI_WC_GROUP, VI_TYPE, VI_ASSIST_PLAYER;
		EXIT WHEN C_GOALS%NOTFOUND;

		IF VI_ASSIST_PLAYER IS NOT NULL THEN VO_ASSISTS := 1;
			ELSE  VO_ASSISTS := 0;
		END IF;

		IF VI_TYPE = 'OG' THEN VO_OWN_GOALS := 1;
			ELSE VO_OWN_GOALS := 0;
		END IF;   

		UPDATE WORLDCUP_PLAYERS
		SET GOALS = (
			(SELECT GOALS FROM WORLDCUP_PLAYERS 
				WHERE PLAYER = VI_PLAYER 
				AND NATION = VI_NATION
				AND WC_GROUP = VI_WC_GROUP) +1)
		WHERE PLAYER = VI_PLAYER
		AND NATION = VI_NATION
		AND WC_GROUP = VI_WC_GROUP;
		--COMMIT;

		UPDATE WORLDCUP_PLAYERS
		SET OWN_GOALS = (
			(SELECT OWN_GOALS FROM WORLDCUP_PLAYERS 
				WHERE PLAYER = VI_PLAYER 
				AND NATION = VI_NATION
				AND WC_GROUP = VI_WC_GROUP) + VO_OWN_GOALS)
		WHERE PLAYER = VI_PLAYER
		AND NATION = VI_NATION
		AND WC_GROUP = VI_WC_GROUP;
		--COMMIT;

        UPDATE WORLDCUP_PLAYERS
        SET ASSISTS = (
            (SELECT ASSISTS FROM WORLDCUP_PLAYERS
                WHERE PLAYER = VI_ASSIST_PLAYER
                AND NATION = VI_NATION
                AND WC_GROUP = VI_WC_GROUP) + VO_ASSISTS)
        WHERE PLAYER = VI_ASSIST_PLAYER
        AND NATION = VI_NATION
        AND WC_GROUP = VI_WC_GROUP;
        --COMMIT;

	END LOOP;
	CLOSE C_GOALS;


--POPULATE YELLOW AND RED CARD COUNTS
	OPEN C_CARDS;
	LOOP
		FETCH C_CARDS INTO VI_PLAYER, VI_NATION, VI_WC_GROUP, VI_COLOR;
		EXIT WHEN C_CARDS%NOTFOUND;

		VO_YELLOW := 0;
		VO_RED := 0;

		IF VI_COLOR = 'Y' THEN VO_YELLOW := 1;
			ELSIF VI_COLOR = 'YY' THEN VO_YELLOW := 1;
			ELSIF VI_COLOR = 'R' THEN VO_RED := 1;
		END IF;

		UPDATE WORLDCUP_PLAYERS
		SET YELLOW_CARDS = (
			(SELECT YELLOW_CARDS FROM WORLDCUP_PLAYERS
				WHERE PLAYER = VI_PLAYER
				AND NATION = VI_NATION
				AND WC_GROUP = VI_WC_GROUP) + VO_YELLOW)
		WHERE PLAYER = VI_PLAYER
		AND NATION = VI_NATION
		AND WC_GROUP = VI_WC_GROUP;
		--COMMIT;

		UPDATE WORLDCUP_PLAYERS
		SET RED_CARDS = (
			(SELECT RED_CARDS FROM WORLDCUP_PLAYERS
				WHERE PLAYER = VI_PLAYER
				AND NATION = VI_NATION
				AND WC_GROUP = VI_WC_GROUP) + VO_RED)
		WHERE PLAYER = VI_PLAYER
		AND NATION = VI_NATION
		AND WC_GROUP = VI_WC_GROUP;
		--COMMIT;

	END LOOP;
	CLOSE C_CARDS;
END;